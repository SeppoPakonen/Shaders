{"ver":"0.1","info":{"id":"XdVfWd","date":"1531085646","viewed":259,"name":"N-Body Gravity Simulation","username":"mackycheese21","description":"N-body gravitaty simulation using Buf A for acceleration storage, Buf B for velocity storage and Buf C for position storage.","likes":7,"published":1,"flags":32,"tags":[]},"renderpass":[{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":2,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dfGRr","channel":0}],"code":"//Main image\n//Render\n\n//Buf A=acc\n//Buf B=vel\n//Buf C=pos\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    int w=int(iResolution.x);\n    int h=int(iResolution.y);\n    float zoom=1.0;\n    vec2 pos=fragCoord.xy*zoom;\n\tfragColor=vec4(vec3(0.5),1.0);\n    for(int i=0;i<NUM_BODIES;i++){\n        vec2 o_pos=(getBodyPos(iChannel2,i,w,h)+0.5)*iResolution.xy;\n        if(length(pos-o_pos)<MASS*20.0){\n            vec2 vel=getBodyVel(iChannel1,i,w,h);\n            float ang=atan(vel.y/vel.x)/3.1415926536;\n            fragColor=vec4(hsv2rgb(vec3(ang,0.5,1.0)),1.0);\n        }\n    }\n}","name":"Image","description":"","type":"image"},{"inputs":[],"outputs":[],"code":"#define NUM_BODIES 1500\n#define GRAV_CONST 0.01\n#define DT 0.025\n#define MIN_DIST 0.0000001\n#define MASS 0.1\n#define NUM_INIT_FRAMES 30\n//Buf A=acc\n//Buf B=vel\n//Buf C=pos\n\n//iResolution.x=460\n//TODO: Fix when NUM_BODIES>iResolution.x that all bodies\n//with id>=NUM_BODIES are redundant at the same position\n\nvec3 hsv2rgb(vec3 c) {\n    vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n}\n\nfloat random( vec2 p ){\n    vec2 r = vec2(\n        23.14069263277926, // e^pi (Gelfond's constant)\n         2.665144142690225 // 2^sqrt(2) (Gelfond\u00e2\u20ac\u201cSchneider constant)\n    );\n    return fract( cos( mod( 12345678., 256. * dot(p,r) ) ) );\n}\n\n\n\nivec2 getPos(int id,int w,int h){\n    return ivec2(id%int(w),id/int(h));\n}\n\nint getID(ivec2 px,int w,int h){\n    return px.x+px.y*w;\n}\n\nvec2 getBodyPos(sampler2D sampler,int id,int w,int h){\n    return texelFetch(sampler,getPos(id,w,h),0).xy;\n}\nvec2 getBodyVel(sampler2D sampler,int id,int w,int h){\n    return texelFetch(sampler,getPos(id,w,h),0).xy;\n}\nvec2 getBodyAcc(sampler2D sampler,int id,int w,int h){\n    return texelFetch(sampler,getPos(id,w,h),0).xy;\n}","name":"Common","description":"","type":"common"},{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":2,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dXGR8","channel":0}],"code":"//Buf A=ACC\n//Buf B=vel\n//Buf C=pos\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    int w=int(iResolution.x);\n    int h=int(iResolution.y);\n    ivec2 px=ivec2(fragCoord);\n    int id=getID(px,w,h);\n    if(id>=NUM_BODIES){\n        fragColor=vec4(vec3(0.0),1.0);\n        return;\n    }\n    \n    \n    vec2 pos=getBodyPos(iChannel2,id,w,h);\n    vec2 acc=vec2(0.0,0.0);\n    float mul=1.0;\n    for(int o_id=0;o_id<NUM_BODIES&&iFrame!=0;o_id++){\n        if(o_id==id)continue;\n        vec2 o_pos=getBodyPos(iChannel2,o_id,w,h);\n        float d=length(pos-o_pos);\n        if(d<MIN_DIST){\n            //mul*=0.01;\n            continue;\n        }\n        acc-=(pos-o_pos)*MASS*MASS*GRAV_CONST/d/d;\n    }\n    if(iFrame<NUM_INIT_FRAMES){\n        acc=vec2(0.0,0.0);\n    }\n    \n    fragColor=vec4(acc*mul,0.0,1.0);\n        \n}","name":"Buffer A","description":"","type":"buffer"},{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":2,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"XsXGR8","channel":0}],"code":"//Buf A=acc\n//Buf B=VEL\n//Buf C=pos\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    \n    int w=int(iResolution.x);\n    int h=int(iResolution.y);\n    ivec2 px=ivec2(fragCoord);\n    int id=getID(px,w,h);\n    if(id>=NUM_BODIES){\n        fragColor=vec4(vec3(0.0),1.0);\n        return;\n    }\n\n    vec2 vel=getBodyVel(iChannel1,id,w,h);\n    vec2 acc=getBodyAcc(iChannel0,id,w,h);\n    vel+=acc*DT;\n    if(iFrame<NUM_INIT_FRAMES){\n        vel=vec2(0.0,0.0);\n    }\n    fragColor=vec4(vel,0.0,1.0);\n}","name":"Buffer B","description":"","type":"buffer"},{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":2,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4sXGR8","channel":0}],"code":"//Buf A=acc\n//Buf B=vel\n//Buf C=POS\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    \n    int w=int(iResolution.x);\n    int h=int(iResolution.y);\n    ivec2 px=ivec2(fragCoord);\n    int id=getID(px,w,h);\n    if(id>=NUM_BODIES){\n        fragColor=vec4(vec3(0.0),1.0);\n        return;\n    }\n\n    vec2 pos=getBodyPos(iChannel2,id,w,h);\n    vec2 vel=getBodyVel(iChannel1,id,w,h);\n    vec2 npos=pos+vel*DT;\n    pos=npos;\n    if(iFrame<=NUM_INIT_FRAMES){\n        pos.x=random(vec2(float(id),124.5523+iTime));\n        pos.y=random(vec2(float(id),6935.24356+iTime));\n        pos*=2.;\n        pos-=1.;\n    }\n    fragColor=vec4(pos,0.0,1.0);\n}","name":"Buffer C","description":"","type":"buffer"}]}