{"ver":"0.1","info":{"id":"lt3czH","date":"1531502897","viewed":145,"name":"Raymarch loop optimization","username":"UnstableLobster","description":"Replacing the usual for loop with a do-while seems to give some improvements, at least on hlsl, probably because of the removed branching.","likes":1,"published":1,"flags":0,"tags":[]},"renderpass":[{"inputs":[],"outputs":[{"id":"4dfGRr","channel":0}],"code":"#define float3 vec3\n\nvec3 ro;\nvec3 rd;\nint maxSteps = 128;\nfloat drawDist = 100.0;\nfloat epSI = .0003;\n\n\nfloat map(vec3 p)\n{\n    float a = iTime;\n    float c, s; vec3 q = p;\n\tc = cos(a); s = sin(a);\n\tp.y = c * q.y - s * q.z;\n\tp.z = s * q.y + c * q.z;\n    \n    q = p;\n\tc = cos(a); s = sin(a);\n\tp.x = c * q.x - s * q.z;\n\tp.z = s * q.x + c * q.z;\n    \n    vec3 d = abs(p) - vec3(.5);\n\treturn min(max(d.x, max(d.y, d.z)), 0.0) + length(max(d, 0.0));\n}\n\nvec3 calcNormal( in vec3 pos )\n{\n\tfloat e = 0.5773*0.0005;\n\treturn normalize(\n\t\tfloat3(e, -e, -e)\t* map(pos + float3(e, -e, -e)) +\n\t\tfloat3(-e, -e, e)\t* map(pos + float3(-e, -e, e)) +\n\t\tfloat3(-e, e, -e)\t* map(pos + float3(-e, e, -e)) +\n\t\tfloat3(e, e, e)\t\t* map(pos + float3(e, e, e)));\n}\n\nbool raymarchW(out vec3 pos)\n{\n\tfloat t = .0;\n\tfloat d =.0;\n\tint i = 0;\n\tdo\n\t{\n\t\td = map(ro + rd * t);\n\t\tt += d;\n\t} while (i++ < maxSteps && t < drawDist && d > epSI);\n\n\tpos = ro + rd * t;\n\treturn (t < drawDist);\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    vec2 uv = fragCoord/iResolution.xy;\n    vec3 col = vec3(0);\n    \n\tvec2 screen = (uv - .5) * 2.;\n    screen.y *= iResolution.y / iResolution.x;\n    \n\tro = vec3(screen.x, screen.y, -3.);\n\trd = normalize(ro - vec3(.0, .0, -5.));\n    \n    vec3 pos = vec3(0);\n    if(raymarchW(pos))\n    {\n        float doter = dot(normalize(vec3(-1.234f, 2.234f, -4.213f)), calcNormal(pos)) * .5 + .5;\n        col = pos * vec3(.5) + vec3(.5);\n        col.z = sin(iTime) * .5 + .5;\n        col = vec3(cos(doter));\n    }\n\n    fragColor = vec4(col,1.0);\n}","name":"Image","description":"","type":"image"}]}