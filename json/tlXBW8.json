{"ver":"0.1","info":{"id":"tlXBW8","date":"1617957636","viewed":400,"name":"SVGF","username":"Mathis","description":"WASD to move, mouse to look, hold space to move fast!\nPress n or m to rotate the directional light.","likes":15,"published":1,"flags":48,"usePreview":0,"tags":[]},"renderpass":[{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":2,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XdfGR8","filepath":"/media/previz/buffer03.png","previewfilepath":"/media/previz/buffer03.png","type":"buffer","channel":3,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dfGRr","channel":0}],"code":"/*\nSVGF\n\nThe viewport lags 3 frames behind.\n*/\n\n\nfloat ShadowCone(vec3 pos, vec3 dir, float FAR, float CR, float Time) {\n    float dist=0.; float Occ=1.; float dft,R;\n    for (int i=0; i<128; i++) {\n        dft=SDF(pos+dir*dist,Time).D;\n        if (dist>FAR) break;\n        if (dft<eps.x) return 0.;\n        R=dist*CR;\n        Occ=min(Occ,dft/R);\n        dist=dist+dft;\n    }\n\treturn max(0.,Occ);\n}\n\nvoid mainImage(out vec4 fragColor, in vec2 fragCoord) {\n    //Output\n    vec3 Color=vec3(0.);\n    //Attributes\n    vec2 uv=floor(fragCoord*0.5)+0.5;\n    vec4 CRef=texture(iChannel3,uv*IRES);\n    vec3 Eye=texture(iChannel0,vec2(8.5,0.5)*IRES).xyz;\n    vec3 Pos=texture(iChannel0,vec2(9.5,0.5)*IRES).xyz;\n    vec3 VDir=normalize(vec3((uv*IRES*4.-1.)*(ASPECT*CFOV),1.));\n    vec3 Dir=VDir*TBN(Eye);\n    vec3 LD=texture(iChannel0,vec2(5.5,0.5)*IRES).xyz;\n    if (CRef.w<9999.) {\n        //Final denoising pass and direct light\n        vec3 Tan; vec3 Bit=TBN(Eye,Tan);\n        vec3 HITVP=VDir*CRef.w;\n        vec3 HITN=Read(CRef.z).xyz*2.-1.;\n        vec3 HITVN=vec3(dot(HITN,Tan),dot(HITN,Bit),dot(HITN,Eye));\n        Color=Denoise(uv,uv,iChannel3,1.,HITVP,HITN,HITVN,IRES,CFOV*ASPECT)*I09;\n        //Geometry param (incomplete G-Buffer)\n        DF DFSample=SDF(Pos+Dir*CRef.w,iTime);\n        //Direct light\n        float LDot=dot(LD,HITN);\n        if (LDot>0.) {\n            Color+=SunColor*1.5*(LDot*ShadowCone(Pos+Dir*CRef.w+HITN*0.05,LD,128.,SunConeRatio,iTime));\n        }\n        Color=Color*DFSample.C;\n    } else {\n        //Sky\n        Color=SkyColor*(1.-0.5*Dir.y);\n    }\n    \n    //DEBUG\n    //Color=Read3(texture(iChannel1,fragCoord*IRES*0.5).x).xyz; //Accumulated\n        //Color=Read(texture(iChannel1,fragCoord*IRES*0.5).y).xyz*16.; //xyz*16.; //Varians\n        //Color=vec3(abs(Color.z-Color.y*Color.y))/64.;\n    //Color=Read3(texture(iChannel2,fragCoord*IRES).x).xyz; //Denoising buffers\n    \n    fragColor=vec4(pow(Color,vec3(0.45)),1.);\n}","name":"Image","description":"","type":"image"},{"inputs":[],"outputs":[],"code":"//Settings\nconst float FOV=0.9; //In radians\nconst float ALPHA=1./8.;\nconst float Coeff_L=4.;\nconst float Coeff_Z=1.;\nconst float SunConeRatio=tan(radians(2.)*0.5);\n#define SkyColor vec3(0.1,0.3,0.5)\n#define SunColor vec3(0.99,0.8,0.5)\n\n//Constants\nconst float PI=3.14159265;\nconst float I09=1./0.9;\nconst float I16=1./16.;\nconst float I255=1./255.;\nconst vec2 eps=vec2(0.005,0.);\nconst float CFOV=tan(FOV);\nconst vec2 InvAF=(0.5/CFOV)*vec2(180./320.,1.);\n#define HRES (iResolution.xy*0.5)\n#define IRES 1./iResolution.xy\n#define IHRES 2./iResolution.xy\n#define ASPECT vec2(iResolution.x/iResolution.y,1.)\n\n//Structs\nstruct DF { float D; vec3 C; float Mat; float V_y; };\nstruct HIT { float D; vec3 P; vec3 N; vec3 C; float Mat; float V_y; };\n\n  \nfloat Box(vec3 p, vec3 b) {\n    vec3 d=abs(p-b*0.5)-b*0.5;\n    return min(max(d.x,max(d.y,d.z)),0.)+length(max(d,0.));\n}\n\nfloat BoxC(vec3 p, vec3 b) {\n    vec3 d=abs(p)-b;\n    return min(max(d.x,max(d.y,d.z)),0.)+length(max(d,0.));\n}\n\nfloat Box2(vec2 p, vec2 b) {\n    vec2 d=abs(p-b*0.5)-b*0.5;\n    return min(max(d.x,d.y),0.)+length(max(d,0.));\n}\n\nfloat BoxC2(vec2 p, vec2 b) {\n    vec2 d=abs(p)-b;\n    return min(max(d.x,d.y),0.)+length(max(d,0.));\n}\n\nvec2 Rotate(vec2 p, float ang) {\n    float c=cos(ang), s=sin(ang);\n    return vec2(p.x*c-p.y*s,p.x*s+p.y*c);\n}\n\nvec2 Repeat(vec2 p, float n) {\n    float ang=2.*3.14159/n;\n    float sector=floor(atan(p.x,p.y)/ang+0.5);\n    p=Rotate(p,sector*ang);\n    return p;\n}\n\nfloat Plane(vec3 p, vec3 n, float offs) {\n\treturn dot(p,n)-offs;\n}\n\nfloat Line(vec3 p, vec3 a, vec3 b) {\n    vec3 ba=b-a;\n    float k=dot(p-a,ba)/dot(ba,ba);\n    return length((a+clamp(k,0.,1.)*(b-a))-p);\n}\n\nfloat SMIN(float a, float b, float k) {\n    float h=clamp(0.5+0.5*(b-a)/k,0.,1.);\n    return mix(b,a,h)-k*h*(1.-h);\n}\n\nvoid MIN(inout DF df, DF a) {\n    if (a.D<=df.D) df=a;\n}\n\nDF SDF(vec3 p, float Time) {\n    DF df=DF(1000.,vec3(0.99),1.,0.);\n    //Rum\n    \tdf.D=min(df.D,max(Box(p,vec3(64.,42.,32.)),-Box(p-vec3(2.,1.,2.),vec3(60.,40.,28.)))); //V\u00e4ggar\n    \tvec3 rp=p-vec3(8.,9.,24.); rp.xy=Rotate(rp.xy,3.14159*0.25);\n    \tdf.D=max(df.D,-Box(rp,vec3(16.,16.,16.))); //D\u00f6rr\n    \t//Roterade sf\u00e4rf\u00f6nster\n    \t\trp=p-vec3(64.,16.,16.); rp.yz=Rotate(rp.yz,0.6);\n    \t\tdf.D=max(df.D,-(length(vec3(rp.x,fract(rp.yz*0.125)*8.-4.))-4.));\n    \t//Sphere\n    \t\tMIN(df,DF(length(p-vec3(48.,4.,5.))-4.,vec3(0.6,0.9,0.7),1.,0.));\n    \t//Weird rotated stuff on the wall\n    \t\trp=p-vec3(48.,16.,23.); rp.xy=Rotate(rp.xy,Time);\n    \t\tMIN(df,DF(Box(vec3(abs(rp.xy)-vec2(2.5,2.5),rp.z),vec3(5.,5.,8.)),vec3(0.99,0.9,0.6),0.,0.));\n    //Golv\n    \tMIN(df,DF(Box(p,vec3(64.,1.,54.)),vec3(0.99),1.,0.));\n    \t//F\u00e4rgade golvbitar\n    \t\tMIN(df,DF(Box(p-vec3(24.,1.,20.),vec3(12.,1.,10.)),vec3(0.99,0.1,0.1),1.,0.));\n    \t\tMIN(df,DF(Box(p-vec3(36.,1.,20.),vec3(12.,1.,10.)),vec3(0.1,0.99,0.1),1.,0.));\n    //R\u00f6rlig kvadrat vid d\u00f6rren\n    \tvec3 bp=p-vec3(6.,10.+10.*sin(Time),30.5);\n    \tMIN(df,DF(Box(bp,vec3(26.,20.,1.)),vec3(0.99),1.,10.*cos(Time)));\n    \n    //Return\n\treturn df;\n}\n\nvec3 Gradient(vec3 p, float t) {\n    return normalize(vec3(\n        SDF(p+eps.xyy,t).D-SDF(p-eps.xyy,t).D,\n        SDF(p+eps.yxy,t).D-SDF(p-eps.yxy,t).D,\n        SDF(p+eps.yyx,t).D-SDF(p-eps.yyx,t).D));\n}\n\nmat3 TBN(vec3 N) {\n    vec3 Nb,Nt;\n    if (abs(N.y)>0.999) {\n        Nb=vec3(1.,0.,0.);\n        Nt=vec3(0.,0.,1.);\n    } else {\n    \tNb=normalize(cross(N,vec3(0.,1.,0.)));\n    \tNt=normalize(cross(Nb,N));\n    }\n    return mat3(Nb.x,Nt.x,N.x,Nb.y,Nt.y,N.y,Nb.z,Nt.z,N.z);\n}\n\nvec3 TBN(vec3 N, out vec3 O) {\n    O=normalize(cross(N,vec3(0.,1.,0.)));\n    return normalize(cross(O,N));\n}\n\nfloat boxfar(vec3 origin, vec3 dir, vec3 bmin, vec3 bmax) {\n    vec3 tMin=(bmin-origin)*dir;\n    vec3 tMax=(bmax-origin)*dir;\n    vec3 t2=max(tMin,tMax);\n    return min(min(t2.x,t2.y),t2.z);\n}\n\nvec2 box(vec3 origin, vec3 dir, vec3 bmin, vec3 bmax) {\n    vec3 tMin=(bmin-origin)*dir;\n    vec3 tMax=(bmax-origin)*dir;\n    vec3 t1=min(tMin,tMax);\n    vec3 t2=max(tMin,tMax);\n    return vec2(max(max(t1.x,t1.y),t1.z),min(min(t2.x,t2.y),t2.z));\n}\n\nbool TraceRay(vec3 pos, vec3 dir, out HIT R, float FAR, float Time) {\n    DF t; float dist=0.; R.P=pos;\n    for (int i=0; i<512; i++) {\n        if (dist>FAR) break;\n        R.P=pos+dir*dist;\n        t=SDF(R.P,Time);\n        if (t.D<eps.x) {\n\t\t\tR.D=dist;\n            R.N=Gradient(R.P,Time);\n            R.C=t.C;\n            R.Mat=t.Mat;\n            R.V_y=t.V_y;\n            return true;\n        }\n        dist=dist+t.D;\n    }\n\treturn false;\n}\n\nvec3 RandSample(vec2 v) {\n    float theta=sqrt(v.x);\n    float phi=2.*3.14159*v.y;\n    float x=theta*cos(phi);\n    float z=theta*sin(phi);\n    return vec3(x,z,sqrt(max(0.,1.-v.x)));\n}\n\nvec2 ProjectUV(vec3 p, vec3 LP, vec3 LD, vec3 LT, vec3 LB) {\n\tvec3 CVPos=p-LP;\n    vec3 LVPos=vec3(dot(CVPos,LT),dot(CVPos,LB),dot(CVPos,LD));\n    return (LVPos.xy/LVPos.z)*InvAF+0.5;\n}\n\nvec3 ComputeLight(vec3 P, vec3 D, vec3 N, vec3 LD, vec2 rand, float iTime) {\n    HIT LHIT; mat3 NM; vec3 Sample; vec3 Color=vec3(0.);\n    //Diffuse\n    NM=TBN(N);\n    Sample=RandSample(rand)*NM;\n    if (TraceRay(P,Sample,LHIT,128.,iTime)) {\n        if (LHIT.Mat==2.) Color+=LHIT.C; else {\n            //Direct Light\n            float LDot=dot(LD,LHIT.N);\n            if (LDot>0.) {\n                NM=TBN(LD);\n                Sample=LD;\n                if (!TraceRay(LHIT.P+LHIT.N*0.05,Sample,LHIT,128.,iTime))\n                    Color.xyz+=SunColor*LDot*LHIT.C*1.5;\n            }\n        }\n    } else\n        Color.xyz+=(1.-0.5*Sample.y)*SkyColor;\n    //Return\n    return Color;\n}\n\n//Decode/encode from user \"cornusammonis\": https://www.shadertoy.com/view/Xlfcz8\nuint Write0(vec4 x) {\n\tx = clamp(x,-1.0, 1.0) * 127.0;\n    uvec4 sig = uvec4(mix(vec4(0), vec4(1), greaterThanEqual(sign(x),vec4(0))));\n    uvec4 mag = uvec4(abs(x));\n    uvec4 r = sig << 7 | mag;\n    return r.x << 24 | r.y << 16 | r.z << 8 | r.w;\n}\nvec4 Read0(uint x) {\n\tuvec4 r = (uvec4(x) >> uvec4(24, 16, 8, 0)) & uvec4(0xFF);\n    uvec4 sig = r >> 7;\n    uvec4 mag = r & uvec4(0x7F);\n    vec4 fsig = mix(vec4(-1), vec4(1), greaterThanEqual(sig,uvec4(1)));\n    vec4 fmag = vec4(mag) / 127.0;\n    return fsig * fmag;\n}\nvec4 Read(float x) {\n    return Read0(floatBitsToUint(x))*0.5+0.5;\n}\nfloat Write(vec4 x) {\n    return uintBitsToFloat(Write0(x*2.-1.));\n}\n\nfloat Write3(vec3 v) {\n    return floor(v.x*1000.)*0.001+floor(1000.*v.y)+floor(1000.*v.z)*1000.;\n}\nvec3 Read3(float v) {\n    float vx=fract(v);\n    return vec3(vx,fract((v-vx)*0.001),floor(v*0.001)*0.001);\n}\n\nfloat WeightVar(float deltaZ, float dotN, vec3 deltaL, float L_div_inv) {\n    return max(0.001,dotN)*min(exp(-(deltaZ*deltaZ)*Coeff_Z),1.)\n        \t*min(exp(-dot(deltaL,deltaL)*L_div_inv),1.);\n}\n\nfloat Weight(float deltaZ, float dotN) {\n    return max(0.001,dotN)*min(exp(-(deltaZ*deltaZ)*Coeff_Z),1.);\n}\n\nvec4 _Denoise(vec2 uv, vec2 lUV, vec2 UVoff, vec3 CVP, vec3 CN, vec3 CVN, sampler2D tl,\n            vec2 ires, vec2 asfov, vec3 L0, float LCoeff) {\n    //Denoiser help function\n    vec4 l0=texture(tl,(lUV+UVoff)*ires);\n    vec4 l1=texture(tl,(lUV-UVoff)*ires);\n    vec4 L=vec4(0.); vec3 SP,L1;\n    if (l0.w<9990. && BoxC2((uv+UVoff)*ires-0.25,vec2(0.25))<0.) {\n        SP=normalize(vec3(((uv+UVoff)*ires*4.-1.)*asfov,1.))*l0.w;\n        L1=Read3(l0.x);\n    \t//L+=vec4(L1,1.)*Weight(dot(SP-CVP,CVN),dot(CN,Read(l0.z).xyz*2.-1.)); //Atrous\n        L+=vec4(L1,1.)*WeightVar(dot(SP-CVP,CVN),dot(CN,Read(l0.z).xyz*2.-1.),L1-L0,LCoeff);\n    }\n    if (l1.w<9990. && BoxC2((uv-UVoff)*ires-0.25,vec2(0.25))<0.) {\n        SP=normalize(vec3(((uv-UVoff)*ires*4.-1.)*asfov,1.))*l1.w;\n        L1=Read3(l1.x);\n    \t//L+=vec4(L1,1.)*Weight(dot(SP-CVP,CVN),dot(CN,Read(l1.z).xyz*2.-1.)); //Atrous\n        L+=vec4(L1,1.)*WeightVar(dot(SP-CVP,CVN),dot(CN,Read(l1.z).xyz*2.-1.),L1-L0,LCoeff);\n    }\n    \n    return L;\n}\n\nvec3 Denoise(vec2 uv, vec2 lUV, sampler2D light, float radius, vec3 CVP, vec3 CN, vec3 CVN,\n            vec2 ires, vec2 asfov) {\n    //Improved denoiser\n    vec4 L0=texture(light,lUV*ires);\n    //Variance\n    vec2 Moments=Read(L0.y).yz*16.;\n    float Variance=abs(Moments.y-Moments.x*Moments.x);\n    float LCoeff=1./(Coeff_L*pow(0.707+0.3*0.25*sqrt(Variance),radius-1.)+0.0001);\n    //Wavelet\n    vec3 l0=Read3(L0.x);\n    vec4 Accum=vec4(l0*0.2,0.2);\n    Accum+=(_Denoise(uv,lUV,vec2(radius,0.),CVP,CN,CVN,light,ires,asfov,l0,LCoeff)+\n            _Denoise(uv,lUV,vec2(0.,radius),CVP,CN,CVN,light,ires,asfov,l0,LCoeff)+\n            _Denoise(uv,lUV,vec2(radius*0.707),CVP,CN,CVN,light,ires,asfov,l0,LCoeff)+\n            _Denoise(uv,lUV,vec2(radius,-radius)*0.707,CVP,CN,CVN,light,ires,asfov,l0,LCoeff)\n            )*0.1;\n    //Output\n    return vec3(Accum.xyz/Accum.w);\n}","name":"Common","description":"","type":"common"},{"inputs":[{"id":"4dXGRr","filepath":"/presets/tex00.jpg","previewfilepath":"/presets/tex00.jpg","type":"keyboard","channel":1,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":2,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":3,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dXGR8","channel":0}],"code":"void mainImage(out vec4 fragColor, in vec2 fragCoord) {\n    vec4 Color=texture(iChannel0,fragCoord.xy/iResolution.xy);\n    vec2 fragFloor=floor(fragCoord);\n    if (iFrame==0) { //Initialization\n        if (fragCoord.x<10. && fragCoord.y<1.) { //Store vars\n            if (fragCoord.x<1.) Color=vec4(0.,0.,0.,0.); //Mouse\n            else if (fragCoord.x<2.) Color=vec4(-0.2,0.7,0.,0.); //Player Eye (Angles)\n            else if (fragCoord.x<3.) Color=vec4(0.,0.,0.,1.); //Player Eye (Vector)\n            else if (fragCoord.x<4.) Color=vec4(37.5,15.3,4.5,1.); //Player Pos\n            else if (fragCoord.x<5.) Color=vec4(0.55,-0.6,0.,0.); //Sun angles\n            else if (fragCoord.x<6.) Color=vec4(0.,0.,0.,0.); //Sun direction\n        }\n    } else { //Update\n\t\tif (fragCoord.x<16. && fragCoord.y<1.) { //Update vars\n            if (fragCoord.x<1.) { //Mouse\n                if (iMouse.z>0.) { //B\u00f6rjat klicka\n                    if (Color.w==0.) {\n                    \tColor.w=1.;\n                    \tColor.xy=iMouse.zw;\n                    }\n                } else Color.w=0.;\n            } else if (fragCoord.x<2.) { //Player Eye (Angles)\n                vec4 LMouse=texture(iChannel0,vec2(0.5,0.5)*IRES);\n                if (LMouse.w==0.)  Color.zw=Color.xy;\n                if (LMouse.w==1.) {\n                \t//Y led\n                \tColor.x=Color.z+(iMouse.y-LMouse.y)*0.01;\n                \tColor.x=clamp(Color.x,-2.8*0.5,2.8*0.5);\n                \t//X led\n                \tColor.y=Color.w-(iMouse.x-LMouse.x)*0.02;\n               \t\tColor.y=mod(Color.y,3.1415926*2.);\n                }\n            } else if (fragCoord.x<3.) { //Player Eye (Vector)\n                vec3 Angles=texture(iChannel0,vec2(1.5,0.5)*IRES).xyz;\n                Color.xyz=normalize(vec3(cos(Angles.x)*sin(Angles.y),\n                  \t\t\t   \t\t\tsin(Angles.x),\n                  \t\t\t   \t\t\tcos(Angles.x)*cos(Angles.y)));\n            } else if (fragCoord.x<4.) { //Player Pos\n                float Speed=iTimeDelta*8.;\n                \tif (texelFetch(iChannel1,ivec2(32,0),0).x>0.) Speed=20.*iTimeDelta;\n                vec3 Eye=texture(iChannel0,vec2(2.5,0.5)*IRES).xyz;\n                if (texelFetch(iChannel1,ivec2(87,0),0).x>0. ||\n                    texelFetch(iChannel1,ivec2(38,0),0).x>0.) Color.xyz+=Eye*Speed; //W\n                if (texelFetch(iChannel1,ivec2(83,0),0).x>0. ||\n                    texelFetch(iChannel1,ivec2(40,0),0).x>0.) Color.xyz-=Eye*Speed; //S\n                vec3 Tan=normalize(cross(vec3(Eye.x,0.,Eye.z),vec3(0.,1.,0.)));\n                if (texelFetch(iChannel1,ivec2(65,0),0).x>0. ||\n                    texelFetch(iChannel1,ivec2(37,0),0).x>0.) Color.xyz-=Tan*Speed; //A\n                if (texelFetch(iChannel1,ivec2(68,0),0).x>0. ||\n                    texelFetch(iChannel1,ivec2(39,0),0).x>0.) Color.xyz+=Tan*Speed; //D\n            } else if (fragCoord.x<5.) { //Sun angle\n                if (texelFetch(iChannel1,ivec2(77,0),0).x>0.) Color.y+=0.02;\n                if (texelFetch(iChannel1,ivec2(78,0),0).x>0.) Color.y-=0.02;\n                Color.z=Color.y; //Sunangle last frame\n            } else if (fragCoord.x<6.) { //Sun direction\n                vec2 Angles=texture(iChannel0,vec2(4.5,0.5)*IRES).xy;\n                Color=vec4(normalize(vec3(cos(Angles.y)*cos(Angles.x)\n                \t,sin(Angles.x),sin(Angles.y)*cos(Angles.x))),1.);\n            } else if (fragCoord.x<7.) { //Last frame dir\n                Color=texture(iChannel0,vec2(2.5,0.5)*IRES);\n            } else if (fragCoord.x<8.) { //Last frame position\n                Color=texture(iChannel0,vec2(3.5,0.5)*IRES);\n            } else if (fragCoord.x<9.) { //2 last frame dir\n                Color=texture(iChannel0,vec2(6.5,0.5)*IRES);\n            } else if (fragCoord.x<10.) { //2 last frame position\n                Color=texture(iChannel0,vec2(7.5,0.5)*IRES);\n            } else if (fragCoord.x<11.) { //3 last frame dir\n                Color=texture(iChannel0,vec2(8.5,0.5)*IRES);\n            } else if (fragCoord.x<12.) { //3 last frame position\n                Color=texture(iChannel0,vec2(9.5,0.5)*IRES);\n            } else if (fragCoord.x<13.) { //4 last frame dir\n                Color=texture(iChannel0,vec2(10.5,0.5)*IRES);\n            } else if (fragCoord.x<14.) { //4 last frame position\n                Color=texture(iChannel0,vec2(11.5,0.5)*IRES);\n            }\n        } else if (fragCoord.y>HRES.y) {\n            if (fragCoord.x>HRES.x)\n                //Copy last frames attributes\n            \tColor=texture(iChannel2,fragCoord*IRES);\n            else\n                Color=texture(iChannel3,fragCoord*IRES+vec2(0.5,0.));\n        }\n    }\n    fragColor=Color;\n}","name":"Buffer A","description":"","type":"buffer"},{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":2,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsBSR3","filepath":"/media/a/cb49c003b454385aa9975733aff4571c62182ccdda480aaba9a8d250014f00ec.png","previewfilepath":"/media/ap/cb49c003b454385aa9975733aff4571c62182ccdda480aaba9a8d250014f00ec.png","type":"texture","channel":3,"sampler":{"filter":"nearest","wrap":"repeat","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"XsXGR8","channel":0}],"code":"vec3 LinearSample0(vec2 uv, out float coeff, out vec3 Moments, vec3 CN) {\n    vec4 Attr=texture(iChannel2,uv+vec2(0.5,0.));\n    if (Attr.w>9999. || BoxC2(uv-0.25,vec2(0.25))>0.) {coeff=0.001; Moments=vec3(0.); return vec3(0.); }\n    coeff=max(0.001,dot(CN,Read(Attr.z).xyz*2.-1.));\n    Moments=Read(Attr.y).xyz*coeff;\n    return Read3(Attr.x)*coeff;\n}\n\nvec3 LinearSample(vec2 uv, vec3 CN, out vec3 Moments) {\n    //*\n    float c0,c1,c2,c3; vec3 m0,m1,m2,m3;\n    vec2 fuv=floor(uv*HRES-0.499)+0.5;\n    vec3 C0=LinearSample0(fuv*IRES,c0,m0,CN);\n    vec3 C1=LinearSample0((fuv+vec2(1.,0.))*IRES,c1,m1,CN);\n    vec3 C2=LinearSample0((fuv+vec2(0.,1.))*IRES,c2,m2,CN);\n    vec3 C3=LinearSample0((fuv+vec2(1.))*IRES,c3,m3,CN);\n    vec2 fruv=fract(uv*HRES-0.499);\n    float mc=mix(mix(c0,c1,fruv.x),mix(c2,c3,fruv.x),fruv.y)+0.02;\n    Moments=mix(mix(m0,m1,fruv.x),mix(m2,m3,fruv.x),fruv.y)/mc;\n    return mix(mix(C0,C1,fruv.x),mix(C2,C3,fruv.x),fruv.y)/mc;\n    //*/\n    /*\n    vec2 fuv=floor(uv*HRES-0.499)+0.5; float c0;\n    vec3 C0=LinearSample0(fuv*IRES,c0,Moments,CN);\n    return C0/c0; //*/\n}\n\nvoid mainImage(out vec4 fragColor, in vec2 fragCoord) {\n    vec4 Color=vec4(0.);\n    if (fragCoord.y<HRES.y && fragCoord.x<HRES.x) {\n        //New 1 spp light\n        vec3 LD=texture(iChannel0,vec2(5.5,0.5)*IRES).xyz;\n        //Primary rays\n        vec2 uv=fragCoord*IHRES;\n        vec3 Pos=texture(iChannel0,vec2(3.5,0.5)*IRES).xyz;\n        mat3 MM=TBN(texture(iChannel0,vec2(2.5,0.5)*IRES).xyz);\n        vec3 Dir=normalize(vec3((uv*2.-1.)*(ASPECT*CFOV),1.)*MM);\n        HIT Pixel;\n        if (TraceRay(Pos,Dir,Pixel,128.,iTime)) {\n            vec3 Light;\n            if (Pixel.Mat==2.)\n                Light=Pixel.C;\n            else {\n                float modsum=mod(floor(fragCoord.x),4.)+mod(floor(fragCoord.y),4.);\n                float modframe=mod(float(iFrame),256.);\n                vec2 rand=texture(iChannel3,(fragCoord+modframe*vec2(325.253,537.171))*IRES).xy;\n                Light=ComputeLight(Pixel.P+Pixel.N*0.05,Dir,Pixel.N,LD,rand,iTime);\n            }\n            //Accumulation\n            float NSamples=1.;\n            vec2 MixedMoments=vec2(1.,0.);\n            vec3 LLPos=texture(iChannel0,vec2(7.5,0.5)*IRES).xyz;\n            vec3 LLEye=texture(iChannel0,vec2(6.5,0.5)*IRES).xyz;\n            vec3 LLTan=normalize(cross(LLEye,vec3(0.,1.,0.)));\n            vec3 LLBit=normalize(cross(LLTan,LLEye));\n            //Reprojection\n            vec2 Luv=ProjectUV(Pixel.P,LLPos,LLEye,LLTan,LLBit);\n            vec4 LLA=texture(iChannel2,Luv*0.5+vec2(0.5,0.));\n            vec3 LLPP=LLPos+normalize(vec3((Luv*2.-1.)*(ASPECT*CFOV),1.)*TBN(LLEye))*LLA.w;\n            if (BoxC2(Luv-0.5,vec2(0.5))>0. || length(LLPP-Pixel.P)>2.\n            ) { //|| dot(Pixel.N,Read(LLA.z).xyz*2.-1.)<0.5) {\n            } else if (iFrame>0) {\n                //Valid pixel\n                vec3 AccumMoments;\n                vec3 AccumLight=LinearSample(Luv,Pixel.N,AccumMoments);\n                NSamples=min(64.,AccumMoments.x*255.+1.);\n                if (NSamples>3.) {\n                    //Stable temporal variance\n                    float Lum=dot(Light.xyz,vec3(0.299,0.587,0.114));\n                    MixedMoments=AccumMoments.yz*(1.-ALPHA)+vec2(Lum,Lum*Lum)*ALPHA;\n                }  \n                MixedMoments=clamp(MixedMoments,vec2(0.),vec2(1.))*0.99;\n                Light=AccumLight*(1.-ALPHA)+Light.xyz*ALPHA;\n            }\n            //Return\n            Color=vec4(Write3(min(Light,vec3(0.9))),\n                        Write(vec4(NSamples*I255,MixedMoments,0.)),\n                        Write(vec4((Pixel.N*0.5+0.5)*0.99,0.)),\n                        Pixel.D);\n        } else {\n            Color=vec4(Write3(vec3(0.)),\n                        Write(vec4(0.)),\n                        Write(vec4(0.)),\n                        10000.);\n        }\n    }\n    fragColor=Color;\n}","name":"Buffer B","description":"","type":"buffer"},{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":2,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4sXGR8","channel":0}],"code":"void mainImage(out vec4 fragColor, in vec2 fragCoord) {\n    vec4 Color=vec4(0.);\n    if (fragCoord.x>HRES.x) {\n        if (fragCoord.y<HRES.y) {\n            //Old accumulated\n            Color=texture(iChannel1,fragCoord*IRES+vec2(-0.5,0.));\n        }\n    } else {\n        if (fragCoord.y<HRES.y) {\n            //Denoising pass 1\n            vec2 uv=fragCoord;\n            vec4 CRef=texture(iChannel1,fragCoord*IRES);\n            //World to view space attributes\n            vec3 Eye=texture(iChannel0,vec2(2.5,0.5)*IRES).xyz;\n            vec3 VDir=normalize(vec3((uv*IRES*4.-1.)*(ASPECT*CFOV),1.));\n            vec3 Tan; vec3 Bit=TBN(Eye,Tan);\n            vec3 HITVP=VDir*CRef.w;\n            vec3 HITN=Read(CRef.z).xyz*2.-1.;\n            vec3 HITVN=vec3(dot(HITN,Tan),dot(HITN,Bit),dot(HITN,Eye));\n            vec3 Denoised=Denoise(uv,fragCoord,iChannel1,16.,HITVP,HITN,HITVN,IRES,CFOV*ASPECT);\n            Color=vec4(Write3(min(Denoised,vec3(0.9))),CRef.yzw);\n        } else {\n            //Denoising pass 2\n            vec2 uv=fragCoord-vec2(0.,HRES.y);\n            vec4 CRef=texture(iChannel2,fragCoord*IRES-vec2(0.,0.5));\n            //World to view space attributes\n            vec3 Eye=texture(iChannel0,vec2(6.5,0.5)*IRES).xyz;\n            vec3 VDir=normalize(vec3((uv*IRES*4.-1.)*(ASPECT*CFOV),1.));\n            vec3 Tan; vec3 Bit=TBN(Eye,Tan);\n            vec3 HITVP=VDir*CRef.w;\n            vec3 HITN=Read(CRef.z).xyz*2.-1.;\n            vec3 HITVN=vec3(dot(HITN,Tan),dot(HITN,Bit),dot(HITN,Eye));\n            vec3 Denoised=Denoise(uv,fragCoord-vec2(0.,HRES.y),iChannel2,\n                                    8.,HITVP,HITN,HITVN,IRES,CFOV*ASPECT);\n            Color=vec4(Write3(min(Denoised,vec3(0.9))),CRef.yzw);\n        }\n    }\n    fragColor=Color;\n}","name":"Buffer C","description":"","type":"buffer"},{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":1,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XdfGR8","filepath":"/media/previz/buffer03.png","previewfilepath":"/media/previz/buffer03.png","type":"buffer","channel":2,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"XdfGR8","channel":0}],"code":"void mainImage(out vec4 fragColor, in vec2 fragCoord) {\n    vec4 Color=vec4(0.);\n    if (fragCoord.x<HRES.x) {\n        if (fragCoord.y>HRES.y) {\n            //Denoising pass 3\n            vec2 uv=fragCoord-vec2(0.,HRES.y);\n            vec4 CRef=texture(iChannel1,fragCoord*IRES);\n            //World to view space attributes\n            vec3 Eye=texture(iChannel0,vec2(6.5,0.5)*IRES).xyz;\n            vec3 VDir=normalize(vec3((uv*IRES*4.-1.)*(ASPECT*CFOV),1.));\n            vec3 Tan; vec3 Bit=TBN(Eye,Tan);\n            vec3 HITVP=VDir*CRef.w;\n            vec3 HITN=Read(CRef.z).xyz*2.-1.;\n            vec3 HITVN=vec3(dot(HITN,Tan),dot(HITN,Bit),dot(HITN,Eye));\n            vec3 Denoised=Denoise(uv,fragCoord,iChannel1,4.,HITVP,HITN,HITVN,IRES,CFOV*ASPECT);\n            Color=vec4(Write3(min(Denoised,vec3(0.9))),CRef.yzw);\n        } else {\n            //Denoising pass 4\n            vec2 uv=fragCoord;\n            vec4 CRef=texture(iChannel2,fragCoord*IRES+vec2(0.,0.5));\n            //World to view space attributes\n            vec3 Eye=texture(iChannel0,vec2(8.5,0.5)*IRES).xyz;\n            vec3 VDir=normalize(vec3((uv*IRES*4.-1.)*(ASPECT*CFOV),1.));\n            vec3 Tan; vec3 Bit=TBN(Eye,Tan);\n            vec3 HITVP=VDir*CRef.w;\n            vec3 HITN=Read(CRef.z).xyz*2.-1.;\n            vec3 HITVN=vec3(dot(HITN,Tan),dot(HITN,Bit),dot(HITN,Eye));\n            vec3 Denoised=Denoise(uv,fragCoord+vec2(0.,HRES.y),iChannel2,\n                                    2.,HITVP,HITN,HITVN,IRES,CFOV*ASPECT);\n            Color=vec4(Write3(min(Denoised,vec3(0.9))),CRef.yzw);\n        }\n    }\n    fragColor=Color;\n}","name":"Buffer D","description":"","type":"buffer"}]}