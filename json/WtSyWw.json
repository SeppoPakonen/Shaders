{"ver":"0.1","info":{"id":"WtSyWw","date":"1596111390","viewed":309,"name":"Heightmap Cone Tracing","username":"Mathis","description":"Look around with mouse\nWASD to move\nSpace to move faster","likes":14,"published":1,"flags":48,"usePreview":0,"tags":[]},"renderpass":[{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":2,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dfGRr","channel":0}],"code":"//Heightmap cone tracing\n\nvec4 Lod0Fetch(vec3 cp) {\n    // SC1,Sc2 osv -> mixa intensiteterna\n    vec4 SC=texture(iChannel0,(cp.xz+vec2(0.,1.))*IRES);\n    float Occ0=clamp(SC.x-abs(cp.y-SC.x*0.5)*2.,0.,1.);\n    SC=texture(iChannel0,(cp.xz+vec2(1.,1.))*IRES);\n    float Occ1=clamp(SC.x-abs(cp.y-SC.x*0.5)*2.,0.,1.);\n    SC=texture(iChannel0,(cp.xz+vec2(0.,2.))*IRES);\n    float Occ2=clamp(SC.x-abs(cp.y-SC.x*0.5)*2.,0.,1.);\n    SC=texture(iChannel0,(cp.xz+vec2(1.,2.))*IRES);\n    float Occ3=clamp(SC.x-abs(cp.y-SC.x*0.5)*2.,0.,1.);\n    vec2 fuv=fract(cp.xz);\n    return vec4(vec3(0.),1.)*mix(mix(Occ0,Occ1,fuv.x),mix(Occ2,Occ3,fuv.x),fuv.y);\n}\n\nvec4 Lod1Fetch(vec3 cp) {\n    vec4 SC=texture(iChannel2,(cp.xz*0.5)*IRES); float Occ0=clamp(SC.x*0.5-abs(cp.y-SC.x*0.5),0.,1.);\n    SC=texture(iChannel2,(cp.xz*0.5+vec2(1.,0.))*IRES); float Occ1=clamp(SC.x*0.5-abs(cp.y-SC.x*0.5),0.,1.);\n    SC=texture(iChannel2,(cp.xz*0.5+vec2(0.,1.))*IRES); float Occ2=clamp(SC.x*0.5-abs(cp.y-SC.x*0.5),0.,1.);\n    SC=texture(iChannel2,(cp.xz*0.5+1.)*IRES); float Occ3=clamp(SC.x*0.5-abs(cp.y-SC.x*0.5),0.,1.);\n    vec2 fuv=fract(cp.xz*0.5);\n    return vec4(vec3(0.),1.)*mix(mix(Occ0,Occ1,fuv.x),mix(Occ2,Occ3,fuv.x),fuv.y);\n}\n\nvec4 Lod2Fetch(vec3 cp) {\n    cp.xz=vec2(cp.x*0.25+128.,cp.z*0.25);\n    vec4 SC=texture(iChannel2,(cp.xz)*IRES); float Occ0=clamp(SC.x*0.25-abs(cp.y-SC.x*0.5)*0.5,0.,1.);\n    SC=texture(iChannel2,(cp.xz+vec2(1.,0.))*IRES); float Occ1=clamp(SC.x*0.25-abs(cp.y-SC.x*0.5)*0.5,0.,1.);\n    SC=texture(iChannel2,(cp.xz+vec2(0.,1.))*IRES); float Occ2=clamp(SC.x*0.25-abs(cp.y-SC.x*0.5)*0.5,0.,1.);\n    SC=texture(iChannel2,(cp.xz+1.)*IRES); float Occ3=clamp(SC.x*0.25-abs(cp.y-SC.x*0.5)*0.5,0.,1.);\n    vec2 fuv=fract(cp.xz);\n    return vec4(vec3(0.),1.)*mix(mix(Occ0,Occ1,fuv.x),mix(Occ2,Occ3,fuv.x),fuv.y);\n}\n\nvec4 Lod3Fetch(vec3 cp) {\n    cp.xz=vec2(cp.x*0.125+192.,cp.z*0.125);\n    vec4 SC=texture(iChannel2,(cp.xz)*IRES); float Occ0=clamp(SC.x*0.125-abs(cp.y-SC.x*0.5)*0.25,0.,1.);\n    SC=texture(iChannel2,(cp.xz+vec2(1.,0.))*IRES); float Occ1=clamp(SC.x*0.125-abs(cp.y-SC.x*0.5)*0.25,0.,1.);\n    SC=texture(iChannel2,(cp.xz+vec2(0.,1.))*IRES); float Occ2=clamp(SC.x*0.125-abs(cp.y-SC.x*0.5)*0.25,0.,1.);\n    SC=texture(iChannel2,(cp.xz+1.)*IRES); float Occ3=clamp(SC.x*0.125-abs(cp.y-SC.x*0.5)*0.25,0.,1.);\n    vec2 fuv=fract(cp.xz);\n    return vec4(vec3(0.),1.)*mix(mix(Occ0,Occ1,fuv.x),mix(Occ2,Occ3,fuv.x),fuv.y);\n}\n\nvec4 Lod4Fetch(vec3 cp) {\n    cp.xz=vec2(cp.x/16.+224.,cp.z/16.);\n    vec4 SC=texture(iChannel2,(cp.xz)*IRES); float Occ0=clamp(SC.x/16.-abs(cp.y-SC.x*0.5)*0.125,0.,1.);\n    SC=texture(iChannel2,(cp.xz+vec2(1.,0.))*IRES); float Occ1=clamp(SC.x/16.-abs(cp.y-SC.x*0.5)*0.125,0.,1.);\n    SC=texture(iChannel2,(cp.xz+vec2(0.,1.))*IRES); float Occ2=clamp(SC.x/16.-abs(cp.y-SC.x*0.5)*0.125,0.,1.);\n    SC=texture(iChannel2,(cp.xz+1.)*IRES); float Occ3=clamp(SC.x/16.-abs(cp.y-SC.x*0.5)*0.125,0.,1.);\n    vec2 fuv=fract(cp.xz);\n    return vec4(vec3(0.),1.)*mix(mix(Occ0,Occ1,fuv.x),mix(Occ2,Occ3,fuv.x),fuv.y);\n}\n\nvec4 QuadCone60(vec3 p, vec3 d) {\n    vec4 C=vec4(0.);\n    vec3 cp=p+d;\n    C+=Lod0Fetch(cp-vec3(0.5,0.,0.5))*(1.-C.w);\n    cp+=d;\n    C+=Lod1Fetch(cp-vec3(1.,0.,1.))*(1.-C.w);\n    cp+=d*2.;\n    C+=Lod2Fetch(cp-vec3(2.,0.,2.))*(1.-C.w);\n    cp+=d*4.;\n    C+=Lod3Fetch(cp-vec3(4.,0.,4.))*(1.-C.w);\n    cp+=d*8.;\n    C+=Lod4Fetch(cp-vec3(8.,0.,8.))*(1.-C.w);\n    return C+vec4(0.2,0.5,0.9,0.)*((1.-C.w)*(d.y*0.5+0.5));\n}\n\nvec4 QuadRay(vec3 p, vec3 d) {\n    vec3 IDir=1./d;\n    float FAR=boxfar2(p.xz,IDir.xz,vec2(0.),vec2(HRES));\n    float dist=0.; float LFar=FAR; vec3 cp,fp; vec2 bb; vec4 C;\n    float LOD=LODS;\n    float LS=pow(2.,LOD);\n    float ILS=pow(0.5,LOD);\n    for (int i=0; i<72; i++) {\n        if (dist>FAR) break;\n        if (dist>LFar && LOD<LODS) {\n            LOD=LOD+1.;\n            LS*=2.;\n            ILS*=0.5;\n            fp=floor(cp*ILS)*LS;\n            LFar=boxfar2(p.xz,IDir.xz,fp.xz,fp.xz+LS);\n        }\n        cp=p+d*dist;\n        fp=floor(cp*ILS)*LS;\n        C=((LOD==0.)?texture(iChannel0,(fp.xz+vec2(0.5,1.5))*IRES):\n           texture(iChannel2,(fp.xz*ILS+vec2(LOD_OFF[int(LOD)]+0.5,0.5))*IRES));\n        bb=box(p,IDir,vec3(fp.x,0.,fp.z),vec3(fp.x+LS,C.x,fp.z+LS));\n        if ((bb.x>=0. && bb.y>bb.x) || Box(p-vec3(fp.x,0.,fp.z),vec3(LS,C.x,LS))<=0.) {\n            if (LOD==0.) {\n                return vec4(boxN(p,IDir,vec3(fp.x,0.,fp.z),vec3(fp.x+LS,C.x,fp.z+LS)),bb.x);\n            } else if (LOD>0.) {\n                LFar=boxfar2(p.xz,IDir.xz,fp.xz,fp.xz+LS);\n                LOD-=1.;\n                LS*=0.5;\n                ILS*=2.;\n                continue;\n            }\n        }\n        dist+=boxfar2(cp.xz,IDir.xz,fp.xz,fp.xz+LS)+0.001;\n    }\n    return vec4(-1.);\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord ) {\n    vec2 uv=fragCoord.xy/iResolution.xy;\n    float Rot=-(iMouse.x/iResolution.x)*3.14*3.;\n\tvec3 Pos=texture(iChannel0,vec2(3.5,0.5)*IRES).xyz;\n    mat3 MM=TBN(texture(iChannel0,vec2(2.5,0.5)*IRES).xyz);\n    vec3 Dir=normalize(vec3((uv*2.-1.)*(Aspect*1.1),1.)*MM);\n    vec3 Color=vec3(0.);\n\t//Trace\n    vec4 RayDist=QuadRay(Pos,Dir);\n    if (RayDist.w>=0.) {\n        vec3 PixelP=Pos+Dir*RayDist.w;\n        vec3 PixelN=RayDist.xyz;\n        //Diffuse cones\n        mat3 NM=TBN(PixelN);\n        Color=(QuadCone60(PixelP,PixelN).xyz+\n               (QuadCone60(PixelP,vec3(0.707,0.,0.707)*NM).xyz+\n               QuadCone60(PixelP,vec3(-0.707,0.,0.707)*NM).xyz+\n               QuadCone60(PixelP,vec3(0.,0.707,0.707)*NM).xyz+\n               QuadCone60(PixelP,vec3(0.,-0.707,0.707)*NM).xyz)*0.707)*0.2;\n    } else {\n        Color=vec3(0.2,0.5,0.9)*(Dir.y*0.5+0.5);\n    }\n    \n    \n    //DEBUG\n    //Color=texture(iChannel2,uv*0.5).xxx/64.;\n    \n    fragColor=vec4(pow(Color,vec3(0.45)),1.);\n}","name":"Image","description":"","type":"image"},{"inputs":[],"outputs":[],"code":"//CONSTANTS\nconst float HRES=256.;\nconst float I1024=1./1024.;\nconst float LODS=6.;\nconst vec2 eps=vec2(0.001,0.);\nconst float LOD_SUM[8]=float[8](254.,252.,248.,240.,224.,192.,128.,0.);\nconst float LOD_OFF[9]=float[9](0.,0.,128.,192.,224.,240.,248.,252.,254.);\nconst float LOD_PIXELS=HRES*(1.-pow(0.5,LODS));\nconst float IHRES=1./HRES;\n//Resolution\n#define IRES 1./iResolution.xy\n#define Aspect vec2(iResolution.x/iResolution.y,1.)\n\nfloat Box(vec3 p, vec3 b) {\n    vec3 d=abs(p-b*0.5)-b*0.5;\n    return min(max(d.x,max(d.y,d.z)),0.)+length(max(d,0.));\n}\n\nmat3 TBN(vec3 N) {\n    vec3 Nb,Nt;\n    if (abs(N.y)>0.999) {\n        Nb=vec3(1.,0.,0.);\n        Nt=vec3(0.,0.,1.);\n    } else {\n    \tNb=normalize(cross(N,vec3(0.,1.,0.)));\n    \tNt=normalize(cross(Nb,N));\n    }\n    return mat3(Nb.x,Nt.x,N.x,Nb.y,Nt.y,N.y,Nb.z,Nt.z,N.z);\n}\n\nfloat boxfar(vec3 origin, vec3 dir, vec3 bmin, vec3 bmax) {\n    vec3 tMin=(bmin-origin)*dir;\n    vec3 tMax=(bmax-origin)*dir;\n    vec3 t2=max(tMin,tMax);\n    return min(min(t2.x,t2.y),t2.z);\n}\n\nfloat boxfar2(vec2 origin, vec2 dir, vec2 bmin, vec2 bmax) {\n    vec2 tMin=(bmin-origin)*dir;\n    vec2 tMax=(bmax-origin)*dir;\n    vec2 t2=max(tMin,tMax);\n    return min(t2.x,t2.y);\n}\n\nvec2 box(vec3 origin, vec3 dir, vec3 bmin, vec3 bmax) {\n    vec3 tMin=(bmin-origin)*dir;\n    vec3 tMax=(bmax-origin)*dir;\n    vec3 t1=max(tMin,tMax);\n    vec3 t2=min(tMin,tMax);\n    return vec2(max(max(t2.x,t2.y),t2.z),min(min(t1.x,t1.y),t1.z));\n}\n\nbool box(vec3 origin, vec3 dir, vec3 bmin, vec3 bsize, out vec2 bb) {\n    vec3 tMin=(bmin-origin)*dir;\n    vec3 tMax=(bmin+bsize-origin)*dir;\n    vec3 t1=min(tMin,tMax);\n    vec3 t2=max(tMin,tMax);\n    bb=vec2(max(max(t1.x,t1.y),t1.z),min(min(t2.x,t2.y),t2.z));\n    return ((bb.x>0. && bb.x<bb.y) || (bb.x<0. && bb.y>0.));\n}\n\nvec3 boxN(vec3 origin, vec3 dir, vec3 bmin, vec3 bmax) {\n    vec3 tMin=(bmin-origin)*dir;\n    vec3 tMax=(bmax-origin)*dir;\n    vec3 t2=min(tMin,tMax);\n    return ((t2.x>t2.y && t2.x>t2.z)?vec3(-sign(dir.x),0.,0.):((t2.y>t2.z)?\n    \t\t\t\tvec3(0.,-sign(dir.y),0.):vec3(0.,0.,-sign(dir.z))));\n}\n\n\n\nconst float i99=1./99.;\nconst float i099=1./0.99;\nfloat decode(vec3 v) { return v.x*0.99+floor(v.y*99.)+floor(v.z*99.)*100.; }\nvec3 encode(float f) {\n    float fx=fract(f);\n    float fy=(f-fx)*0.01;\n    return vec3(fx*i099,fract(fy)*i099,floor(fy)*i99);\n}\n\nbool Triangle(vec3 p, vec3 d, vec3 p0, vec3 p1, vec3 p2, inout vec4 nd) {\n    //Triangle intersection from:\n    //    https://stackoverflow.com/questions/54564286/triangle-intersection-test-in-opengl-es-glsl\n    vec3 e0 = p1 - p0;\n    vec3 e1 = p0 - p2;\n    nd.xyz = cross( e1, e0 );\n    vec3 e2 = ( 1.0 / dot( nd.xyz, d ) ) * ( p0 - p );\n    vec3 i  = cross( d, e2 );\n    vec3 barycentricCoord=vec3(0.);\n    barycentricCoord.y = dot( i, e1 );\n    barycentricCoord.z = dot( i, e0 );\n    barycentricCoord.x = 1.0 - (barycentricCoord.z + barycentricCoord.y);\n    nd.w  = dot( nd.xyz, e2 );\n    return (nd.w > 0.) && all(greaterThanEqual(barycentricCoord, vec3(0.0)));\n}\n\nvec4 TraceHeightmap(vec3 p, vec3 d, vec2 NEARFAR, float PixSize, float IPixSize, float TRES, vec2 uvOff,\n                    float StartLOD, samplerCube Cube) {\n    //Tracing a heightmap\n        //NEAR m\u00e5ste ocks\u00e5 vara en parameter = max(0.,bb.x)\n    vec3 IDir=1./d; vec3 SD=sign(d);\n    float dist=NEARFAR.x; float FAR=NEARFAR.y; float LFar=FAR; vec2 bb,bMin,bMax,t2;\n    vec3 cp,fp; vec4 C;\n    float LOD=StartLOD;\n    float LS=pow(2.,LOD)*PixSize;\n    float ILS=pow(0.5,LOD)*IPixSize;\n    for (int i=0; i<72; i++) {\n        if (dist>FAR) break;\n        if (dist>LFar && LOD<StartLOD) {\n            LOD=LOD+1.;\n            LS*=2.;\n            ILS*=0.5;\n            fp=floor(cp*ILS)*LS;\n            LFar=boxfar2(p.xz,IDir.xz,fp.xz,fp.xz+LS);\n        }\n        cp=p+d*dist;\n        fp=floor(cp*ILS)*LS;\n        C=texture(Cube,vec3(-1.,(vec2(fp.x*ILS+TRES+2.*TRES\n                        *(1.-ILS*PixSize),fp.z*ILS)+uvOff)*I1024*2.-1.).yxz);\n        if (box(p,IDir,vec3(fp.x,0.,fp.z),vec3(LS,C.x,LS),bb)) {\n            if (LOD==0.) {\n                //return bb.xxxx;\n                C=texture(Cube,vec3(-1.,(fp.xz*ILS+uvOff)*I1024*2.-1.).yxz);\n                vec4 nds; vec4 nd=vec4(0.,0.,0.,10000.);\n                //Improved geometry quality\n                if ((C.x-C.w)*(C.x-C.w)>(C.y-C.z)*(C.y-C.z)) {\n                    if (Triangle(p,d,vec3(fp.x,C.x,fp.z),vec3(fp.x,C.y,fp.z+PixSize)\n                                ,vec3(fp.x+PixSize,C.z,fp.z),nds)) nd=nds;\n                    if (Triangle(p,d,vec3(fp.x+PixSize,C.z,fp.z),vec3(fp.x,C.y,fp.z+PixSize)\n                                ,vec3(fp.x+PixSize,C.w,fp.z+PixSize),nds)) nd=((nds.w<nd.w)?nds:nd);\n                } else {\n                    if (Triangle(p,d,vec3(fp.x,C.x,fp.z),vec3(fp.x,C.y,fp.z+PixSize)\n                                ,vec3(fp.x+PixSize,C.w,fp.z+PixSize),nds)) nd=nds;\n                    if (Triangle(p,d,vec3(fp.x,C.x,fp.z),vec3(fp.x+PixSize,C.w,fp.z+PixSize)\n                                ,vec3(fp.x+PixSize,C.z,fp.z),nds)) nd=((nds.w<nd.w)?nds:nd);\n                }\n                if (nd.w<1000.) return vec4(normalize(nd.xyz),nd.w);\n            } else if (LOD>0.) {\n                LFar=boxfar2(p.xz,IDir.xz,fp.xz,fp.xz+LS);\n                LOD-=1.;\n                LS*=0.5;\n                ILS*=2.;\n                continue;\n            }\n        }\n        bMin=(fp.xz-p.xz)*IDir.xz;\n        bMax=(fp.xz+LS-p.xz)*IDir.xz;\n        t2=max(bMin,bMax);\n        dist=min(t2.x,t2.y)+0.001;\n        //fp.xz+=((t2.x<t2.y)?vec2(SD.x*LS,0.):vec2(0.,SD.z*LS));\n    }\n    return vec4(0.,0.,0.,10000.);\n}","name":"Common","description":"","type":"common"},{"inputs":[{"id":"XdX3Rn","filepath":"/media/a/52d2a8f514c4fd2d9866587f4d7b2a5bfa1a11a0e772077d7682deb8b3b517e5.jpg","previewfilepath":"/media/ap/52d2a8f514c4fd2d9866587f4d7b2a5bfa1a11a0e772077d7682deb8b3b517e5.jpg","type":"texture","channel":3,"sampler":{"filter":"mipmap","wrap":"repeat","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4dXGRr","filepath":"/presets/tex00.jpg","previewfilepath":"/presets/tex00.jpg","type":"keyboard","channel":1,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dXGR8","channel":0}],"code":"//Vars + voxelized scen\n\nvoid mainImage(out vec4 fragColor, in vec2 fragCoord) {\n    vec4 Color=texture(iChannel0,fragCoord.xy/iResolution.xy);\n    if (iFrame==0) { //Initialization\n        if (fragCoord.x<10. && fragCoord.y<1.) { //Store vars\n            if (fragCoord.x<1.) Color=vec4(0.,0.,0.,0.); //Mouse\n            else if (fragCoord.x<2.) Color=vec4(-1.1,0.8,0.,0.); //Player Eye (Angles)\n            else if (fragCoord.x<3.) Color=vec4(0.,0.,0.,1.); //Player Eye (Vector)\n            else if (fragCoord.x<4.) Color=vec4(56.5,80.3,56.5,1.); //Player Pos\n            else if (fragCoord.x<5.) Color=vec4(0.2,2.9,0.,1.); //Sun angles\n            else if (fragCoord.x<6.) Color=vec4(0.,0.,0.,1.); //Sun direction\n        }\n    } else { //Update\n\t\tif (fragCoord.x<10. && fragCoord.y<1.) { //Update vars\n            if (fragCoord.x<1.) { //Mouse\n                if (iMouse.z>0.) { //B\u00f6rjat klicka\n                    if (Color.w==0.) {\n                    \tColor.w=1.;\n                    \tColor.xy=iMouse.zw;\n                    }\n                } else Color.w=0.;\n            } else if (fragCoord.x<2.) { //Player Eye (Angles)\n                vec4 LMouse=texture(iChannel0,vec2(0.5,0.5)*IRES);\n                if (LMouse.w==0.)  Color.zw=Color.xy;\n                if (LMouse.w==1.) {\n                \t//Y led\n                \tColor.x=Color.z+(iMouse.y-LMouse.y)*0.01;\n                \tColor.x=clamp(Color.x,-2.8*0.5,2.8*0.5);\n                \t//X led\n                \tColor.y=Color.w-(iMouse.x-LMouse.x)*0.02;\n               \t\tColor.y=mod(Color.y,3.1415926*2.);\n                }\n            } else if (fragCoord.x<3.) { //Player Eye (Vector)\n                vec3 Angles=texture(iChannel0,vec2(1.5,0.5)*IRES).xyz;\n                Color.xyz=normalize(vec3(cos(Angles.x)*sin(Angles.y),\n                  \t\t\t   \t\t\tsin(Angles.x),\n                  \t\t\t   \t\t\tcos(Angles.x)*cos(Angles.y)));\n            } else if (fragCoord.x<4.) { //Player Pos\n                float Speed=4.*iTimeDelta;\n                \tif (texelFetch(iChannel1,ivec2(32,0),0).x>0.) Speed=28.*iTimeDelta;\n                vec3 Eye=texture(iChannel0,vec2(2.5,0.5)*IRES).xyz;\n                if (texelFetch(iChannel1,ivec2(87,0),0).x>0.) Color.xyz+=Eye*Speed; //W\n                if (texelFetch(iChannel1,ivec2(83,0),0).x>0.) Color.xyz-=Eye*Speed; //S\n                vec3 Tan=normalize(cross(vec3(Eye.x,0.,Eye.z),vec3(0.,1.,0.)));\n                if (texelFetch(iChannel1,ivec2(65,0),0).x>0.) Color.xyz-=Tan*Speed; //A\n                if (texelFetch(iChannel1,ivec2(68,0),0).x>0.) Color.xyz+=Tan*Speed; //D\n            } else if (fragCoord.x<5.) { //Sun angle\n                if (texelFetch(iChannel1,ivec2(188,0),0).x>0.) Color.y+=0.02;\n                if (texelFetch(iChannel1,ivec2(190,0),0).x>0.) Color.y-=0.02;\n            } else if (fragCoord.x<6.) { //Sun direction\n                vec2 Angles=texture(iChannel0,vec2(4.5,0.5)*IRES).xy;\n                Color=vec4(normalize(vec3(cos(Angles.y),1.,sin(Angles.y))),1.);\n            }\n        } else if (fragCoord.x<HRES && fragCoord.y<HRES+1.) {\n            vec2 uv=vec2(fragCoord.x,fragCoord.y-1.);\n            Color=vec4(max(1.,texture(iChannel3,uv*IHRES).x*20.),0.,0.,0.);\n            Color.x=((Box(vec3(uv.x,4.,uv.y)-vec3(128.,0.,32.),vec3(32.))<0.)?50.:Color.x); //Kub\n            Color.x=((length(uv-vec2(60.,150.))<32.)?max(1.,\n            \t\tsqrt(1024.-pow(length(uv-vec2(60.,150.)),2.))):Color.x); //Sf\u00e4r\n        }\n    }\n    fragColor=Color;\n}","name":"Buffer A","description":"","type":"buffer"},{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":1,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4sXGR8","channel":0}],"code":"//LOD\n\nvoid mainImage(out vec4 fragColor, in vec2 fragCoord) {\n    vec4 Color=vec4(0.); vec4 SC;\n    if (fragCoord.x<=LOD_PIXELS) {\n        float LOD=floor(log2(HRES-fragCoord.x));\n        float LRES=pow(2.,LOD);\n        if (fragCoord.y<=LRES) {\n            vec2 LODuv=floor(vec2(fragCoord.x-LOD_SUM[int(LOD)],fragCoord.y))*2.+0.5;\n            Color=vec4(0.,1000.,0.,0.);\n            if (fragCoord.x<=HRES*0.5) {\n                LODuv.y+=1.;\n            \tSC=texture(iChannel0,LODuv*IRES);\n                Color.xz=max(Color.xz,SC.xz); Color.y=min(Color.y,SC.y);\n                SC=texture(iChannel0,(LODuv+1.)*IRES);\n                Color.xz=max(Color.xz,SC.xz); Color.y=min(Color.y,SC.y);\n                SC=texture(iChannel0,(LODuv+vec2(1.,0.))*IRES);\n                Color.xz=max(Color.xz,SC.xz); Color.y=min(Color.y,SC.y);\n                SC=texture(iChannel0,(LODuv+vec2(0.,1))*IRES);\n                Color.xz=max(Color.xz,SC.xz); Color.y=min(Color.y,SC.y);\n            } else {\n                LODuv.x=LODuv.x+LOD_SUM[int(LOD)+1];\n                SC=texture(iChannel1,LODuv*IRES);\n                Color.xz=max(Color.xz,SC.xz); Color.y=min(Color.y,SC.y);\n                SC=texture(iChannel1,(LODuv+1.)*IRES);\n                Color.xz=max(Color.xz,SC.xz); Color.y=min(Color.y,SC.y);\n                SC=texture(iChannel1,(LODuv+vec2(1.,0.))*IRES);\n                Color.xz=max(Color.xz,SC.xz); Color.y=min(Color.y,SC.y);\n                SC=texture(iChannel1,(LODuv+vec2(0.,1))*IRES);\n                Color.xz=max(Color.xz,SC.xz); Color.y=min(Color.y,SC.y);\n            }\n        }\n    }\n    fragColor=Color;\n}","name":"Buffer C","description":"","type":"buffer"}]}