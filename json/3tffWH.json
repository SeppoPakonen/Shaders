{"ver": "0.1", "info": {"id": "3tffWH", "date": "1596546343", "viewed": 141, "name": "Global Ray Bundles", "username": "Mathis", "description": "Parallell Global Ray Bundles implemented in 2D.\nIdeally, I would not use a temporal solution.\n\nUse mouse to draw, see controls in Image.", "likes": 8, "published": 1, "flags": 48, "tags": ["radio", "radiosity"], "requires": ["library", "texturebuf", "keyboardbuf", "imagebuf", "texture"]}, "renderpass": [{"inputs": [{"id": "XdfGR8", "filepath": "/media/previz/buffer03.png", "previewfilepath": "/media/previz/buffer03.png", "type": "buffer", "channel": 3, "sampler": {"filter": "nearest", "wrap": "clamp", "vflip": "true", "srgb": "false", "internal": "byte"}, "published": 1}], "outputs": [{"id": "4dfGRr", "channel": 0}], "code": "//Controls:\n//Use mouse to draw objects in the scene.\n//\t1 - delete\n//\t2 - diffuse\n//\t3 - emissive\n//\tw - bigger radius\n//\ts - smaller radius\n\n\nvoid mainImage(out vec4 fragColor, in vec2 fragCoord) {\n    vec3 Color=texture(iChannel3,fragCoord*IRES).xyz;\n    fragColor=vec4(pow(Color,vec3(0.45)),1.);\n}", "name": "Image", "description": "", "type": "image"}, {"inputs": [], "outputs": [], "code": "//CONSTANTS\nconst float SimRes=352.;\nconst float RayFAR=512.;\nconst float LODS=5.;\nconst float BUNDLES=16.;\nconst float LAYERS=20.;\nconst float BUNDLES_RES=640.;\nvec3 SkyColor(vec2 dir) {\n    return vec3(0.4,0.7,1.)*0.4+pow(max(0.,dot(dir,vec2(0.707))),16.)*vec3(2.,2.,0.7);\n}\n//OTHER CONSTANTS\n#define IRES 1./iResolution.xy\n#define eps vec2(0.01,0.)\nconst int LODSint=int(LODS);\nconst float ISimRes=1./SimRes;\nconst float HSimRes=SimRes*0.5;\nconst float IBUNDLES=1./BUNDLES;\nconst float LOD_PIXELS=SimRes*(1.-pow(0.5,LODS));\nconst float BUNDLES_PIXELS=BUNDLES*LAYERS;\nconst float BUNDLES_SIZE=sqrt(2.)*SimRes;\nconst float STOCH_ANGLE=3.141592653*IBUNDLES;\n\nstruct DF { float D; vec3 C; }; //Dist, Emissive\n\nfloat Box(vec2 p, vec2 b) {\n    vec2 d=abs(p-b*0.5)-b*0.5;\n    return min(max(d.x,d.y),0.)+length(max(d,0.));\n}\n\nfloat Line(vec2 p, vec2 a, vec2 b) {\n    vec2 ba=b-a;\n    float k=dot(p-a,ba)/dot(ba,ba);\n    return length((a+clamp(k,0.,1.)*(b-a))-p);\n}\n\n\nvoid minn(inout DF a, DF b) {\n    if (b.D<a.D) a=b;\n}\n\nDF SDF(vec2 p) {\n    DF df=DF(Box(p,vec2(SimRes,8.)),vec3(1.)); //V\u00e4gg under\n    \tminn(df,DF(Box(p,vec2(4.,SimRes)),vec3(0.,1.,0.))); //Gr\u00f6n v\u00e4gg\n    \tminn(df,DF(Box(p-vec2(SimRes-4.,0.),vec2(4.,128.)),vec3(1.))); //Vit v\u00e4gg sida\n    \tminn(df,DF(Box(p-vec2(0.,124.),vec2(128.,4.)),vec3(1.))); //Vit v\u00e4gg \u00f6ver\n    \t\tminn(df,DF(Box(p-vec2(SimRes-128.,124.),vec2(128.,4.)),vec3(1.)));\n    \t//Interior\n    \t\tminn(df,DF(Box(p-vec2(SimRes-128.,32.),vec2(4.,128.-32.)),vec3(1.))); //Liten vit v\u00e4gg sida\n    \t\tminn(df,DF(Line(p,vec2(SimRes-80.,28.),vec2(SimRes-24.,80.))-8.,vec3(0.9,0.,0.))); //Linje\n    \t\t\tminn(df,DF(Line(p,vec2(SimRes-70.,116.),vec2(SimRes-40.,116.))-3.,vec3(2.)));\n    \t\t\n    minn(df,DF(length((p-vec2(SimRes*0.5,SimRes-80.))*vec2(0.75,2.))-50.,vec3(1.,1.,0.))); //Gul ellips\n    //Return\n    return df;\n}\n\nvec2 Gradient(vec2 p) {\n    return normalize(vec2(SDF(p+eps.xy).D-SDF(p-eps.xy).D,\n                          SDF(p+eps.yx).D-SDF(p-eps.yx).D));\n}\n\nfloat boxfar(vec2 origin, vec2 dir, vec2 bmin, vec2 bmax) {\n    vec2 tMin=(bmin-origin)*dir;\n    vec2 tMax=(bmax-origin)*dir;\n    vec2 t2=max(tMin,tMax);\n    return min(t2.x,t2.y);\n}\n\nvec2 box(vec2 origin, vec2 dir, vec2 bmin, vec2 bmax) {\n    vec2 tMin=(bmin-origin)*dir;\n    vec2 tMax=(bmax-origin)*dir;\n    vec2 t1=max(tMin,tMax);\n    vec2 t2=min(tMin,tMax);\n    return vec2(max(t2.x,t2.y),min(t1.x,t1.y));\n}\n\nconst float i99=1./99.;\nconst float i099=1./0.99;\nfloat decode(vec2 v) { return v.x*0.99+floor(v.y*1000.); }\nvec2 encode(float f) {\n    float fx=fract(f);\n    float fy=(f-fx);\n    return vec2(fx*i099,fy*0.001);\n}", "name": "Common", "description": "", "type": "common"}, {"inputs": [{"id": "4dXGRr", "filepath": "/presets/tex00.jpg", "previewfilepath": "/presets/tex00.jpg", "type": "keyboard", "channel": 2, "sampler": {"filter": "nearest", "wrap": "clamp", "vflip": "true", "srgb": "false", "internal": "byte"}, "published": 1}, {"id": "4dXGR8", "filepath": "/media/previz/buffer00.png", "previewfilepath": "/media/previz/buffer00.png", "type": "buffer", "channel": 0, "sampler": {"filter": "nearest", "wrap": "clamp", "vflip": "true", "srgb": "false", "internal": "byte"}, "published": 1}, {"id": "XsBSR3", "filepath": "/media/a/cb49c003b454385aa9975733aff4571c62182ccdda480aaba9a8d250014f00ec.png", "previewfilepath": "/media/ap/cb49c003b454385aa9975733aff4571c62182ccdda480aaba9a8d250014f00ec.png", "type": "texture", "channel": 3, "sampler": {"filter": "nearest", "wrap": "repeat", "vflip": "true", "srgb": "false", "internal": "byte"}, "published": 1}], "outputs": [{"id": "4dXGR8", "channel": 0}], "code": "//Scene + LODS\n\nvoid mainImage(out vec4 fragColor, in vec2 fragCoord) {\n    vec4 Color=texture(iChannel0,fragCoord*IRES);\n    if (fragCoord.x<SimRes && fragCoord.y<SimRes) {\n    \tif (iFrame<LODSint) {\n            //Build scene\n            Color=vec4(0.,0.,0.,0.);\n            DF Sample=SDF(fragCoord);\n            if (Sample.D<0.) {\n                Color=vec4(Sample.C,1.);\n            }\n        } else if (iFrame>LODSint) {\n            //Real time modifying\n            vec4 Info0=texture(iChannel0,vec2(SimRes+1.5,0.5)*IRES);\n            vec4 Info1=texture(iChannel0,vec2(SimRes+2.5,0.5)*IRES);\n            if (Info0.y==0. && Line(fragCoord,iMouse.xy,Info0.zw)<Info1.y) {\n                if (Info1.x==0.) Color=vec4(0.);\n                else if (Info1.x==1.) Color=vec4(vec3(0.99),1.);\n                else Color=vec4(vec3(2.),1.);\n            }\n        }\n    } else if (Box(fragCoord-vec2(SimRes+1.,0.),vec2(2.,1.))<0.) {\n        //Lagring av knappar\n        //\tvec4(Offset,Antal_frames,Knapp012,0)\n        if (iFrame==0) {\n            Color=vec4(0.);\n            if (fragCoord.x>SimRes+2.) Color=vec4(1.,1.5,0.,0.);\n        } else {\n            if (fragCoord.x<SimRes+2.) {\n                //vec4(AngleOffset,TemporalSamples,LastMouse.xy)\n                Color.x=texture(iChannel3,(vec2(iFrame,floor(float(iFrame)/1024.))+0.5)/1024.).x;\n                Color.y=Color.y+1.;\n                if (iMouse.xy!=Color.zw) {\n                    Color.y=0.;\n                    Color.zw=iMouse.xy;\n                }\n            } else {\n                //Type of object\n                if (texelFetch(iChannel2,ivec2(49,0),0).x>0.) Color.x=0.;      //delete\n                else if (texelFetch(iChannel2,ivec2(50,0),0).x>0.) Color.x=1.; //diffuse\n                else if (texelFetch(iChannel2,ivec2(51,0),0).x>0.) Color.x=2.; //emissive\n                //Size of radius\n                if (texelFetch(iChannel2,ivec2(87,0),0).x>0.) Color.y=min(Color.y+1.,16.);\n                if (texelFetch(iChannel2,ivec2(83,0),0).x>0.) Color.y=max(Color.y-1.,1.5);\n            }\n        }\n    }\n\tfragColor=Color;   \n}", "name": "Buffer A", "description": "", "type": "buffer"}, {"inputs": [{"id": "4dXGR8", "filepath": "/media/previz/buffer00.png", "previewfilepath": "/media/previz/buffer00.png", "type": "buffer", "channel": 0, "sampler": {"filter": "nearest", "wrap": "clamp", "vflip": "true", "srgb": "false", "internal": "byte"}, "published": 1}, {"id": "XsXGR8", "filepath": "/media/previz/buffer01.png", "previewfilepath": "/media/previz/buffer01.png", "type": "buffer", "channel": 1, "sampler": {"filter": "nearest", "wrap": "clamp", "vflip": "true", "srgb": "false", "internal": "byte"}, "published": 1}], "outputs": [{"id": "XsXGR8", "channel": 0}], "code": "//LOD\n\nvoid mainImage(out vec4 fragColor, in vec2 fragCoord) {\n    vec4 Color=vec4(0.,0.,0.,1.); vec4 SC;\n    if (fragCoord.x<=LOD_PIXELS) {\n        float LOD=floor(-log2(1.-fragCoord.x/SimRes))+1.;\n        float LPower=pow(0.5,LOD);\n        float LRES=SimRes*LPower;\n        float LOffset=SimRes*(1.-LPower);\n        if (fragCoord.y<=LRES) {\n            vec2 LODuv=vec2(0.,floor(fragCoord.y)*2.+0.5);\n            Color=vec4(0.,0.,0.,0.);\n            if (fragCoord.x<=SimRes*0.5) {\n                LODuv.x=floor(fragCoord.x)*2.+0.5;\n            \tColor=(texture(iChannel0,LODuv*IRES)+texture(iChannel0,(LODuv+1.)*IRES)+\n                \ttexture(iChannel0,(LODuv+vec2(1.,0.))*IRES)+\n                    texture(iChannel0,(LODuv+vec2(0.,1))*IRES))*0.25;\n            } else {\n                LODuv.x=floor(fragCoord.x-LOffset)*2.+0.5+((LOD==0.)?0.:SimRes*(1.-LPower*2.));\n                Color=(texture(iChannel1,LODuv*IRES)+texture(iChannel1,(LODuv+1.)*IRES)+\n                \ttexture(iChannel1,(LODuv+vec2(1.,0.))*IRES)+\n                    texture(iChannel1,(LODuv+vec2(0.,1))*IRES))*0.25;\n            }\n        }\n    }\n    fragColor=Color;\n}", "name": "Buffer B", "description": "", "type": "buffer"}, {"inputs": [{"id": "4dXGR8", "filepath": "/media/previz/buffer00.png", "previewfilepath": "/media/previz/buffer00.png", "type": "buffer", "channel": 0, "sampler": {"filter": "nearest", "wrap": "clamp", "vflip": "true", "srgb": "false", "internal": "byte"}, "published": 1}, {"id": "XsXGR8", "filepath": "/media/previz/buffer01.png", "previewfilepath": "/media/previz/buffer01.png", "type": "buffer", "channel": 1, "sampler": {"filter": "nearest", "wrap": "clamp", "vflip": "true", "srgb": "false", "internal": "byte"}, "published": 1}, {"id": "XdfGR8", "filepath": "/media/previz/buffer03.png", "previewfilepath": "/media/previz/buffer03.png", "type": "buffer", "channel": 2, "sampler": {"filter": "nearest", "wrap": "clamp", "vflip": "true", "srgb": "false", "internal": "byte"}, "published": 1}], "outputs": [{"id": "4sXGR8", "channel": 0}], "code": "//Parallell rays\n\nvec4 QuadRay(vec2 p, vec2 d, float CurrentLayer) {\n    vec4 Info0=texture(iChannel0,vec2(SimRes+1.5,0.5)*IRES);\n    vec2 IDir=1./d; float FAR,Ldist; float dist=0.;\n    vec2 bb=box(p,IDir,vec2(0.5),vec2(SimRes-0.5));\n    if (bb.x>0. && bb.y>bb.x) {\n        FAR=bb.y;\n    \tdist=bb.x+0.01;\n    } else\n        return vec4(0.);\n \tfloat LFar=FAR; vec2 cp,fp,lfp; vec4 C,LC;\n    float LOD=LODS;\n    float LS=pow(2.,LOD);\n    float ILS=pow(0.5,LOD);\n    //Layer ray tracing\n    vec4 Color=vec4(0.);\n    float CLayer=0.;\n    bool INSIDE=false;\n    for (int i=0; i<256; i++) {\n        if (dist>FAR) break;\n        if (dist>LFar && LOD<LODS) {\n            LOD=LOD+1.;\n            LS*=2.;\n            ILS*=0.5;\n            fp=floor(cp*ILS)*LS;\n            LFar=boxfar(p,IDir,fp,fp+LS);\n        }\n        cp=p+d*dist;\n        fp=floor(cp*ILS)*LS;\n        C=((LOD==0.)?texture(iChannel0,(fp+0.5)*IRES):\n           texture(iChannel1,(fp*ILS+vec2(SimRes*(1.-pow(0.5,LOD-1.)),0.)+0.5)*IRES));\n        if ((!INSIDE && C.w>0.) || (INSIDE && C.w<1.)) {\n            if ((!INSIDE && LOD==0.) || (INSIDE && LOD==0. && C.w==0.)) {\n                if (CLayer==CurrentLayer) {\n                    if (INSIDE) {\n                        if (LC.x>1.) return vec4(LC.xyz-1.,Ldist);\n                        else if (Info0.y>0.)\n                            return vec4(texture(iChannel2,(fp+0.5)*IRES).xyz*LC.xyz,Ldist);\n                        else return vec4(0.,0.,0.,Ldist);\n                    } else {\n                        if (C.x>1.) return vec4(C.xyz-1.,dist);\n                        else if (Info0.y>0.)\n                            return vec4(texture(iChannel2,(lfp+0.5)*IRES).xyz*C.xyz,dist); //Problem\n                        else return vec4(0.,0.,0.,dist);\n                    }\n                }\n                CLayer=CLayer+1.;\n                INSIDE=!INSIDE;\n                dist+=2.;\n            } else if (LOD>0.) {\n                LOD-=1.;\n                LS*=0.5;\n                ILS*=2.;\n                LFar=boxfar(p,IDir,fp,fp+LS*2.);\n                continue;\n            }\n        }\n        Ldist=dist;\n        dist+=boxfar(cp,IDir,fp,fp+LS)+0.001;\n        LC=C;\n        lfp=fp;\n    }\n    return vec4(SkyColor(d),RayFAR);\n}\n\nvoid mainImage(out vec4 fragColor, in vec2 fragCoord) {\n    vec4 Color=vec4(0.);\n    if (fragCoord.x<BUNDLES_RES && fragCoord.y<BUNDLES_PIXELS) {\n        float Interp=(fragCoord.x/BUNDLES_RES-0.5)*BUNDLES_SIZE;\n        float Stoch_Angle=texture(iChannel0,vec2(SimRes+1.5,0.5)*IRES).x*STOCH_ANGLE;\n        float Angle=floor(fragCoord.y/LAYERS)*IBUNDLES*3.141592653+Stoch_Angle;\n        vec2 Normal=vec2(cos(Angle),sin(Angle));\n        vec2 Tangent=vec2(-sin(Angle),cos(Angle));\n        //Tracing\n        vec2 Pos=HSimRes+Normal*(SimRes*0.75)+Tangent*Interp;\n        Color=QuadRay(Pos,-Normal,mod(floor(fragCoord.y),LAYERS));\n    }\n    fragColor=Color;\n}", "name": "Buffer C", "description": "", "type": "buffer"}, {"inputs": [{"id": "4dXGR8", "filepath": "/media/previz/buffer00.png", "previewfilepath": "/media/previz/buffer00.png", "type": "buffer", "channel": 0, "sampler": {"filter": "nearest", "wrap": "clamp", "vflip": "true", "srgb": "false", "internal": "byte"}, "published": 1}, {"id": "XsXGR8", "filepath": "/media/previz/buffer01.png", "previewfilepath": "/media/previz/buffer01.png", "type": "buffer", "channel": 1, "sampler": {"filter": "nearest", "wrap": "clamp", "vflip": "true", "srgb": "false", "internal": "byte"}, "published": 1}, {"id": "4sXGR8", "filepath": "/media/previz/buffer02.png", "previewfilepath": "/media/previz/buffer02.png", "type": "buffer", "channel": 2, "sampler": {"filter": "nearest", "wrap": "clamp", "vflip": "true", "srgb": "false", "internal": "byte"}, "published": 1}, {"id": "XdfGR8", "filepath": "/media/previz/buffer03.png", "previewfilepath": "/media/previz/buffer03.png", "type": "buffer", "channel": 3, "sampler": {"filter": "nearest", "wrap": "clamp", "vflip": "true", "srgb": "false", "internal": "byte"}, "published": 1}], "outputs": [{"id": "XdfGR8", "channel": 0}], "code": "//Temporal accumulation\n\nvec3 Integral(vec2 pixel, float angle_off) {\n    vec3 Light=vec3(0.);\n    float Div=0.;\n    vec4 Hit,LHit;\n    for (float B=0.; B<BUNDLES; B++) {\n        float SAngle=(B/BUNDLES)*3.141592653+angle_off;\n    \tvec2 STangent=vec2(-sin(SAngle),cos(SAngle));\n    \tvec2 SNormal=-vec2(STangent.y,-STangent.x);\n        float SDepth=dot(pixel-HSimRes+SNormal*(SimRes*0.75),SNormal);\n    \tfloat SProj=(dot(pixel-HSimRes,STangent)/BUNDLES_SIZE)+0.5;\n        vec2 SUV=vec2(SProj*BUNDLES_RES,B*LAYERS);\n        //Layers\n        Hit=texture(iChannel2,(SUV)*IRES);\n        if (Hit.w>SDepth) {\n            //Sky behind och objekt framf\u00f6r\n            Light+=SkyColor(-SNormal)+Hit.xyz;\n        } else {\n            //Check layers\n            LHit=Hit;\n            for (float L=1.; L<LAYERS; L++) {\n                Hit=texture(iChannel2,(SUV+vec2(0.,L))*IRES);\n                if (Hit.w>SDepth) {\n                    Light+=Hit.xyz+LHit.xyz;\n                    break;\n                }\n                LHit=Hit;\n            }\n        }\n\t}\n    return Light*(IBUNDLES*0.5);\n}\n\nvoid mainImage(out vec4 fragColor, in vec2 fragCoord) {\n    vec2 uv=fragCoord.xy*IRES;\n    vec4 Info0=texture(iChannel0,vec2(SimRes+1.5,0.5)*IRES);\n    vec4 Info1=texture(iChannel0,vec2(SimRes+2.5,0.5)*IRES);\n    //Sample scene\n    vec4 Color=vec4(0.);\n    vec4 Sample=texture(iChannel0,uv);\n    if (iFrame>LODSint) {\n        if (fragCoord.x<SimRes && fragCoord.y<SimRes) {\n            if (Sample.w==0.) {\n                vec3 Frame_Color=Integral(fragCoord,Info0.x*STOCH_ANGLE);\n                Color=vec4((texture(iChannel3,uv).xyz*Info0.y+Frame_Color)/(Info0.y+1.),0.);\n            } else {\n                if (Sample.x>1.) {\n                    Color=vec4(Sample.xyz,1.);\n                } else {\n                    Color=vec4(Sample.xyz*0.25,1.);\n                }\n            }\n        } else {\n            //UI\n            Color=vec4(0.);\n\t\t\tif (length(vec2(fragCoord.x-(SimRes+(iResolution.x-SimRes)*0.5)\n                            ,fragCoord.y-iResolution.y*0.5))<Info1.y) {\n                if (Info1.x==0.) Color.xyz=vec3(mod(floor(fragCoord.x*0.5)+floor(fragCoord.y*0.5),2.))*0.5;\n                else if (Info1.x==1.) Color.xyz=vec3(0.5);\n                else Color.xyz=vec3(2.);\n            }\n        }\n    }\n    \n    \n    //DEBUB\n    //Color=texture(iChannel2,uv); //www*ISimRes*0.25;\n    \n    fragColor=Color;\n}", "name": "Buffer D", "description": "", "type": "buffer"}]}